name: Python package

on: [push]

permissions:
  contents: read
  
jobs:
  build-linux:

    runs-on: ubuntu-latest
    strategy:
      max-parallel: 1
      matrix:
        python-version: ["3.7", "3.8", "3.9", "3.10", "3.11"]

    steps:
    - uses: actions/checkout@v3
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip 
        pip install pytest wheel setuptools "scipy>=0.16" "scikit-learn>=0.16" six "numpy<=1.22.4" sphinx_gallery cython sympy pandas statsmodels patsy pytest
        pip list
        python setup.py build_ext --inplace --cythonize
    - name: Tests
      run: |
        pytest -s -v pyearth
    - name: Build wheel
      run: |
        python setup.py sdist bdist_wheel
    - name: Keep wheels as artifacts
      uses: actions/upload-artifact@v3
      with:
        name: wheel-linux-${{matrix.python-version}}
        path: dist/*.whl
#    - name: Keep c source as artifacts
#      uses: actions/upload-artifact@v3
#      with:
#        name: c-source-${{matrix.python-version}}
#        path: pyearth/*.c
  build-windows:
    runs-on: windows-latest
    strategy:
      max-parallel: 1
      matrix:
        python-version: ["3.7", "3.8", "3.9", "3.10", "3.11"]

    steps:
    - uses: actions/checkout@v3
        
    - name: Download Build Tools for Visual Studio 2019
      run: Invoke-WebRequest -Uri https://aka.ms/vs/16/release/vs_buildtools.exe -OutFile vs_buildtools.exe

    - name: Run vs_buildtools.exe install
      run: ./vs_buildtools.exe --quiet --wait --norestart --nocache --add Microsoft.VisualStudio.Component.VC.Tools.x86.x64 --add Microsoft.VisualStudio.Component.VC.v141.x86.x64 --add Microsoft.VisualStudio.Component.VC.140 --includeRecommended

    - name: Set up Python ${{ matrix.python-version }} x64
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}
        architecture: x64
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pytest wheel setuptools "scipy>=0.16" "scikit-learn>=0.16" six "numpy<=1.22.4" sphinx_gallery cython sympy pandas statsmodels patsy pytest
        pip list
        python setup.py build_ext --inplace --cythonize
    - name: Tests
      run: |
        pytest -s -v pyearth
    - name: Build wheel
      run: |
        python setup.py sdist bdist_wheel
    - name: Keep wheels as artifacts
      uses: actions/upload-artifact@v3
      with:
        name: wheel-windows-${{matrix.python-version}}
        path: dist/*.whl
